name: Deploy to PB Server

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Push to Docker Hub"]
    types: [completed]
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          debug: true
          timeout: 60s
          command_timeout: 300s
          script: |
            set -e
            echo "ğŸš€ Deploying LLVM Obfuscator..."
            
            # Navigate to the deployment directory
            cd /home/devopswale/oaas/
            
            # Verify docker-compose.yml exists
            if [ ! -f docker-compose.yml ]; then
              echo "âŒ docker-compose.yml not found!"
              exit 1
            fi
            
            echo "âœ… Using docker-compose.yml from repository"
            
            # Create necessary directories if they don't exist
            mkdir -p cmd/llvm-obfuscator/reports logs
            
            # Pull latest images from Docker Hub
            echo "ğŸ“¦ Pulling latest images from Docker Hub..."
            docker compose pull
            
            # Stop and remove existing containers (force remove if needed)
            echo "ğŸ›‘ Stopping and removing existing containers..."
            docker compose down --remove-orphans || true
            
            # Force remove any containers with conflicting names
            docker rm -f llvm-obfuscator-backend llvm-obfuscator-frontend 2>/dev/null || true
            
            # Start new containers
            echo "ğŸš€ Starting new containers..."
            docker compose up -d --remove-orphans
            
            # Wait for services to start
            echo "â³ Waiting for services to start..."
            sleep 10
            
            # Show container status
            echo "ğŸ“Š Service Status:"
            docker compose ps
            
            # Clean up old images
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "Hello world"
            echo "ğŸ‰ Deployment completed successfully!"


