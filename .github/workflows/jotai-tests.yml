name: Jotai Benchmark Tests

on:
  push:
    branches:
      - main
      - '*'
      - '*/*'
      - '*/*/*'
      - '*/*/*/*'
  pull_request:
    branches:
      - main
      - '*'
      - '*/*'
      - '*/*/*'
      - '*/*/*/*'

  workflow_dispatch:
    inputs:
      limit:
        description: "Number of benchmarks to test (20-30)"
        required: false
        default: "25"
      level:
        description: "Obfuscation level (1-5)"
        required: false
        default: "3"

jobs:
  test-jotai:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: false

    - name: Download LLVM binaries from release
      id: download-binaries
      run: |
        echo "=========================================="
        echo "Downloading LLVM binaries from release"
        echo "=========================================="
        
        # Use latest release by default
        echo "Fetching latest release..."
        VERSION=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        
        if [ -z "$VERSION" ]; then
          echo "❌ ERROR: No releases found"
          echo ""
          echo "To fix:"
          echo "  1. Go to Actions → 'Store LLVM Binaries in Release'"
          echo "  2. Run the workflow manually with a version (e.g., v1.0.0)"
          echo "  3. This will upload binaries to a GitHub Release"
          echo ""
          exit 1
        fi
        
        echo "Using release version: $VERSION"
        
        # Download the archive
        ARCHIVE_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/llvm-binaries-linux-x86_64.tar.gz"
        echo "Downloading from: $ARCHIVE_URL"
        
        mkdir -p cmd/llvm-obfuscator/plugins/
        curl -L -o /tmp/llvm-binaries.tar.gz "$ARCHIVE_URL" || {
          echo "❌ ERROR: Failed to download binaries from release"
          echo ""
          echo "Release version: $VERSION"
          echo "Please ensure the release exists and contains llvm-binaries-linux-x86_64.tar.gz"
          echo ""
          exit 1
        }
        
        # Extract archive
        cd cmd/llvm-obfuscator/plugins/
        tar -xzf /tmp/llvm-binaries.tar.gz
        rm /tmp/llvm-binaries.tar.gz
        
        echo "✅ Binaries extracted successfully"
        ls -lh linux-x86_64/

    - name: Verify binaries are present (REQUIRED)
      run: |
        echo "=========================================="
        echo "Verifying custom LLVM binaries (REQUIRED)"
        echo "=========================================="
        echo ""
        
        MISSING_BINARIES=0
        
        # Check if binaries exist and are actual files
        if [ ! -f "cmd/llvm-obfuscator/plugins/linux-x86_64/clang" ] || \
           ! file cmd/llvm-obfuscator/plugins/linux-x86_64/clang | grep -q "ELF"; then
          echo "❌ ERROR: clang binary missing or invalid"
          echo "   Run the 'Store LLVM Binaries as Artifacts' workflow first"
          MISSING_BINARIES=1
        else
          echo "✅ Custom clang binary verified"
        fi
        
        if [ ! -f "cmd/llvm-obfuscator/plugins/linux-x86_64/opt" ] || \
           ! file cmd/llvm-obfuscator/plugins/linux-x86_64/opt | grep -q "ELF"; then
          echo "❌ ERROR: opt binary missing or invalid"
          echo "   Run the 'Store LLVM Binaries as Artifacts' workflow first"
          MISSING_BINARIES=1
        else
          echo "✅ Custom opt binary verified"
        fi
        
        if [ $MISSING_BINARIES -eq 1 ]; then
          echo ""
          echo "❌ ERROR: Required custom LLVM binaries are missing"
          echo ""
          echo "To fix:"
          echo "  1. Go to Actions → 'Store LLVM Binaries as Artifacts'"
          echo "  2. Run the workflow manually"
          echo "  3. This bypasses Git LFS quota limits"
          exit 1
        fi
        
        echo "✅ All required binaries verified"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang git

    - name: Install Python dependencies
      working-directory: cmd/llvm-obfuscator
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Jotai CI Tests
      working-directory: cmd/llvm-obfuscator
      env:
        INPUT_LIMIT: ${{ github.event.inputs.limit }}
        LEVEL: ${{ github.event.inputs.level || '3' }}
        RANDOM_SEED: ${{ github.run_number }}
      run: |
        echo "=========================================="
        echo "Computing test parameters..."
        echo "=========================================="

        # If user gave a limit (workflow_dispatch), use it.
        # Otherwise generate limit = (run_number % 11) + 20
        if [ -z "$INPUT_LIMIT" ]; then
          RANDOM_LIMIT=$(( (RANDOM_SEED % 11) + 20 ))
        else
          RANDOM_LIMIT="$INPUT_LIMIT"
        fi

        echo "Benchmark limit: $RANDOM_LIMIT"
        echo "Obfuscation level: $LEVEL"
        echo "Random seed: $RANDOM_SEED"
        echo ""

        echo "=========================================="
        echo "Executing Jotai Benchmark Test Workflow:"
        echo "  1. Get C source files from Jotai"
        echo "  2. Compile baseline binaries"
        echo "  3. Apply LLVM obfuscation"
        echo "  4. Run baseline vs obfuscated"
        echo "  5. Validate functional equivalence"
        echo "  6. Hello world"
        echo "=========================================="
        echo ""

        python3 tests/test_jotai_ci.py \
          --limit "$RANDOM_LIMIT" \
          --level "$LEVEL" \
          --min-success-rate 0.6 \
          --random-seed "$RANDOM_SEED" \
          --output ./jotai_ci_results \
          --json-report ./jotai_ci_summary.json

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jotai-test-results
        path: |
          cmd/llvm-obfuscator/jotai_ci_results/**
          cmd/llvm-obfuscator/jotai_ci_summary.json
        retention-days: 7

    - name: Display summary
      if: always()
      working-directory: cmd/llvm-obfuscator
      run: |
        if [ -f jotai_ci_summary.json ]; then
          echo "## Jotai Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY
        import json
        with open("jotai_ci_summary.json") as f:
            data = json.load(f)
        s = data["summary"]
        print(f"- **Total benchmarks:** {s['total_benchmarks']}")
        print(f"- **Tested:** {s['tested']}")
        print(f"- **Skipped:** {s['skipped']}")
        print(f"- **Success rate:** {s['success_rate']*100:.1f}%")
        print(f"- **Functional tests passed:** {s['functional_success']}/{s['tested']}")
        PYEOF
        fi
