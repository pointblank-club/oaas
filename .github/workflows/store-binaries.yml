name: Store LLVM Binaries in Release

# This workflow stores LLVM binaries as GitHub Release assets
# Run this manually when binaries need to be updated
# Releases provide permanent storage and versioning

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"
      source:
        description: "Source of binaries (lfs, local)"
        required: true
        default: "lfs"
        type: choice
        options:
          - lfs
          - local
      create_release:
        description: "Create new release (or update existing)"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  store-binaries:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: ${{ github.event.inputs.source == 'lfs' }}

    - name: Pull Git LFS files (if using LFS source)
      if: github.event.inputs.source == 'lfs'
      continue-on-error: true
      run: |
        echo "Attempting to pull from LFS..."
        git lfs pull || echo "LFS pull failed, will use existing files if available"

    - name: Prepare binaries for upload
      run: |
        echo "=========================================="
        echo "Preparing LLVM binaries for artifact storage"
        echo "=========================================="
        
        mkdir -p binaries-artifact/linux-x86_64
        mkdir -p binaries-artifact/linux-x86_64/lib
        
        # Copy Linux binaries if they exist
        if [ -f "cmd/llvm-obfuscator/plugins/linux-x86_64/clang" ]; then
          file cmd/llvm-obfuscator/plugins/linux-x86_64/clang | grep -q "ELF" && {
            cp cmd/llvm-obfuscator/plugins/linux-x86_64/clang binaries-artifact/linux-x86_64/clang
            echo "✅ Copied clang binary"
          } || echo "⚠️  clang exists but is LFS pointer"
        else
          echo "⚠️  clang binary not found"
        fi
        
        if [ -f "cmd/llvm-obfuscator/plugins/linux-x86_64/opt" ]; then
          file cmd/llvm-obfuscator/plugins/linux-x86_64/opt | grep -q "ELF" && {
            cp cmd/llvm-obfuscator/plugins/linux-x86_64/opt binaries-artifact/linux-x86_64/opt
            echo "✅ Copied opt binary"
          } || echo "⚠️  opt exists but is LFS pointer"
        else
          echo "⚠️  opt binary not found"
        fi
        
        if [ -f "cmd/llvm-obfuscator/plugins/linux-x86_64/LLVMObfuscationPlugin.so" ]; then
          file cmd/llvm-obfuscator/plugins/linux-x86_64/LLVMObfuscationPlugin.so | grep -q "shared object" && {
            cp cmd/llvm-obfuscator/plugins/linux-x86_64/LLVMObfuscationPlugin.so binaries-artifact/linux-x86_64/LLVMObfuscationPlugin.so
            echo "✅ Copied plugin binary"
          } || echo "⚠️  plugin exists but is LFS pointer"
        else
          echo "⚠️  plugin binary not found"
        fi
        
        # Copy library files if they exist
        if [ -d "cmd/llvm-obfuscator/plugins/linux-x86_64/lib" ]; then
          cp -r cmd/llvm-obfuscator/plugins/linux-x86_64/lib/* binaries-artifact/linux-x86_64/lib/ 2>/dev/null || true
          echo "✅ Copied library files"
        fi
        
        echo ""
        echo "Binary sizes:"
        ls -lh binaries-artifact/linux-x86_64/ 2>/dev/null || echo "No binaries found"
        
        # Verify we have the required binaries
        if [ ! -f "binaries-artifact/linux-x86_64/clang" ] || \
           [ ! -f "binaries-artifact/linux-x86_64/opt" ] || \
           [ ! -f "binaries-artifact/linux-x86_64/LLVMObfuscationPlugin.so" ]; then
          echo ""
          echo "❌ ERROR: Required binaries are missing!"
          echo "   Please ensure binaries are available before running this workflow"
          exit 1
        fi

    - name: Create release archive
      run: |
        cd binaries-artifact
        tar -czf ../llvm-binaries-linux-x86_64.tar.gz linux-x86_64/
        cd ..
        echo "Archive created: llvm-binaries-linux-x86_64.tar.gz"
        ls -lh llvm-binaries-linux-x86_64.tar.gz

    - name: Check if release exists
      id: check-release
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const version = '${{ github.event.inputs.version }}';
          try {
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: version
            });
            core.setOutput('exists', 'true');
            core.setOutput('release-id', release.id.toString());
            console.log(`Release ${version} already exists (ID: ${release.id})`);
          } catch (error) {
            if (error.status === 404) {
              core.setOutput('exists', 'false');
              console.log(`Release ${version} does not exist, will create new`);
            } else {
              throw error;
            }
          }

    - name: Create or get release
      id: release
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const version = '${{ github.event.inputs.version }}';
          const createNew = '${{ github.event.inputs.create_release }}' === 'true';
          const releaseExists = '${{ steps.check-release.outputs.exists }}' === 'true';
          
          if (releaseExists && !createNew) {
            // Use existing release
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: version
            });
            core.setOutput('id', release.id.toString());
            core.setOutput('upload-url', release.upload_url);
            console.log(`Using existing release ${version} (ID: ${release.id})`);
          } else {
            // Create new release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: `LLVM Binaries ${version}`,
              body: `Custom LLVM obfuscator binaries for Linux x86_64\n\n**Version:** ${version}\n**Platform:** linux-x86_64\n**Created:** ${new Date().toISOString()}\n\nThis release contains the custom LLVM toolchain binaries required for the obfuscator.`,
              draft: false,
              prerelease: false
            });
            core.setOutput('id', release.id.toString());
            core.setOutput('upload-url', release.upload_url);
            console.log(`Created new release ${version} (ID: ${release.id})`);
          }

    - name: Upload binaries to release
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          const releaseId = '${{ steps.release.outputs.id }}';
          const archivePath = 'llvm-binaries-linux-x86_64.tar.gz';
          const archiveName = path.basename(archivePath);
          
          // Check if asset already exists and delete it
          try {
            const { data: assets } = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(releaseId)
            });
            
            const existingAsset = assets.find(a => a.name === archiveName);
            if (existingAsset) {
              console.log(`Deleting existing asset: ${archiveName}`);
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: existingAsset.id
              });
            }
          } catch (error) {
            console.log('No existing assets to delete or error checking:', error.message);
          }
          
          // Upload new asset
          const archiveData = fs.readFileSync(archivePath);
          const archiveSize = archiveData.length;
          
          console.log(`Uploading ${archiveName} (${(archiveSize / 1024 / 1024).toFixed(2)} MB)...`);
          
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: parseInt(releaseId),
            name: archiveName,
            data: archiveData
          });
          
          console.log(`✅ Successfully uploaded ${archiveName} to release`);

    - name: Summary
      run: |
        echo "=========================================="
        echo "✅ Binaries stored in release successfully"
        echo "=========================================="
        echo ""
        echo "Release version: ${{ github.event.inputs.version }}"
        echo "Asset: llvm-binaries-linux-x86_64.tar.gz"
        echo ""
        echo "Binaries can now be downloaded in workflows from:"
        echo "  https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}"
        echo ""
        echo "This bypasses Git LFS quota limits and provides versioning!"

