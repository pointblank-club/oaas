name: Store LLVM Binaries in GCP Cloud Storage

# This workflow stores LLVM binaries in GCP Cloud Storage bucket
# Run this manually when binaries need to be updated
# GCP Storage provides permanent storage and versioning without Git LFS quota limits

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Binary version (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"
      source:
        description: "Source of binaries (local, gcp)"
        required: true
        default: "local"
        type: choice
        options:
          - local
          - gcp

env:
  GCP_BUCKET: llvmbins
  GCP_REGION: asia-south2

jobs:
  store-binaries:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: false

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Download binaries from GCP (if using GCP source)
      if: github.event.inputs.source == 'gcp'
      run: |
        echo "=========================================="
        echo "Downloading binaries from GCP Cloud Storage"
        echo "=========================================="
        
        VERSION="${{ github.event.inputs.version }}"
        mkdir -p cmd/llvm-obfuscator/plugins/linux-x86_64
        
        # Download archive from GCP
        gsutil cp "gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-${VERSION}.tar.gz" /tmp/llvm-binaries.tar.gz || {
          echo "⚠️  No existing binaries found for version ${VERSION}, will use local files if available"
          exit 0
        }
        
        # Extract archive
        cd cmd/llvm-obfuscator/plugins/
        tar -xzf /tmp/llvm-binaries.tar.gz
        rm /tmp/llvm-binaries.tar.gz
        cd ../../../
        
        echo "✅ Binaries downloaded from GCP"

    - name: Prepare binaries for upload
      run: |
        echo "=========================================="
        echo "Preparing LLVM binaries for artifact storage"
        echo "=========================================="
        
        mkdir -p binaries-artifact/linux-x86_64
        mkdir -p binaries-artifact/linux-x86_64/lib
        
        # Copy Linux binaries if they exist
        if [ -f "cmd/llvm-obfuscator/plugins/linux-x86_64/clang" ]; then
          file cmd/llvm-obfuscator/plugins/linux-x86_64/clang | grep -q "ELF" && {
            cp cmd/llvm-obfuscator/plugins/linux-x86_64/clang binaries-artifact/linux-x86_64/clang
            echo "✅ Copied clang binary"
          } || echo "⚠️  clang exists but is not a valid ELF binary"
        else
          echo "⚠️  clang binary not found"
        fi
        
        if [ -f "cmd/llvm-obfuscator/plugins/linux-x86_64/opt" ]; then
          file cmd/llvm-obfuscator/plugins/linux-x86_64/opt | grep -q "ELF" && {
            cp cmd/llvm-obfuscator/plugins/linux-x86_64/opt binaries-artifact/linux-x86_64/opt
            echo "✅ Copied opt binary"
          } || echo "⚠️  opt exists but is not a valid ELF binary"
        else
          echo "⚠️  opt binary not found"
        fi
        
        if [ -f "cmd/llvm-obfuscator/plugins/linux-x86_64/LLVMObfuscationPlugin.so" ]; then
          file cmd/llvm-obfuscator/plugins/linux-x86_64/LLVMObfuscationPlugin.so | grep -q "shared object" && {
            cp cmd/llvm-obfuscator/plugins/linux-x86_64/LLVMObfuscationPlugin.so binaries-artifact/linux-x86_64/LLVMObfuscationPlugin.so
            echo "✅ Copied plugin binary"
          } || echo "⚠️  plugin exists but is not a valid shared object"
        else
          echo "⚠️  plugin binary not found"
        fi
        
        # Copy library files if they exist
        if [ -d "cmd/llvm-obfuscator/plugins/linux-x86_64/lib" ]; then
          cp -r cmd/llvm-obfuscator/plugins/linux-x86_64/lib/* binaries-artifact/linux-x86_64/lib/ 2>/dev/null || true
          echo "✅ Copied library files"
        fi
        
        echo ""
        echo "Binary sizes:"
        ls -lh binaries-artifact/linux-x86_64/ 2>/dev/null || echo "No binaries found"
        
        # Verify we have the required binaries
        if [ ! -f "binaries-artifact/linux-x86_64/clang" ] || \
           [ ! -f "binaries-artifact/linux-x86_64/opt" ] || \
           [ ! -f "binaries-artifact/linux-x86_64/LLVMObfuscationPlugin.so" ]; then
          echo ""
          echo "❌ ERROR: Required binaries are missing!"
          echo "   Please ensure binaries are available before running this workflow"
          exit 1
        fi

    - name: Create archive
      run: |
        cd binaries-artifact
        tar -czf ../llvm-binaries-linux-x86_64.tar.gz linux-x86_64/
        cd ..
        echo "Archive created: llvm-binaries-linux-x86_64.tar.gz"
        ls -lh llvm-binaries-linux-x86_64.tar.gz

    - name: Upload binaries to GCP Cloud Storage
      run: |
        echo "=========================================="
        echo "Uploading binaries to GCP Cloud Storage"
        echo "=========================================="
        
        VERSION="${{ github.event.inputs.version }}"
        ARCHIVE_NAME="llvm-binaries-linux-x86_64-${VERSION}.tar.gz"
        ARCHIVE_PATH="llvm-binaries-linux-x86_64.tar.gz"
        
        # Rename archive with version
        cp "${ARCHIVE_PATH}" "${ARCHIVE_NAME}"
        
        # Upload to GCP bucket
        echo "Uploading ${ARCHIVE_NAME} to gs://${GCP_BUCKET}/..."
        gsutil cp "${ARCHIVE_NAME}" "gs://${GCP_BUCKET}/${ARCHIVE_NAME}"
        
        # Also upload as latest (for convenience)
        echo "Uploading as latest version..."
        gsutil cp "${ARCHIVE_NAME}" "gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-latest.tar.gz"
        
        # Set metadata
        gsutil -m setmeta -h "Content-Type:application/gzip" \
          -h "Cache-Control:public, max-age=3600" \
          "gs://${GCP_BUCKET}/${ARCHIVE_NAME}" \
          "gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-latest.tar.gz"
        
        echo "✅ Successfully uploaded binaries to GCP Cloud Storage"
        echo "   Versioned: gs://${GCP_BUCKET}/${ARCHIVE_NAME}"
        echo "   Latest: gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-latest.tar.gz"
        
        # List uploaded files
        echo ""
        echo "Files in bucket:"
        gsutil ls -lh "gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-*.tar.gz" || true

    - name: Summary
      run: |
        echo "=========================================="
        echo "✅ Binaries stored in GCP Cloud Storage successfully"
        echo "=========================================="
        echo ""
        echo "Version: ${{ github.event.inputs.version }}"
        echo "Bucket: ${GCP_BUCKET}"
        echo "Region: ${GCP_REGION}"
        echo ""
        echo "Binaries can now be downloaded in workflows from:"
        echo "  gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-${{ github.event.inputs.version }}.tar.gz"
        echo "  gs://${GCP_BUCKET}/llvm-binaries-linux-x86_64-latest.tar.gz"
        echo ""
        echo "This bypasses Git LFS quota limits and provides versioning!"

