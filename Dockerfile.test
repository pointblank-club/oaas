FROM ubuntu:22.04

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# ============================================================================
# STAGE 1: Install LLVM/MLIR from pre-built packages (SPACE EFFICIENT!)
# Using apt.llvm.org for latest LLVM packages
# ============================================================================

RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    ninja-build \
    git \
    python3 \
    python3-pip \
    wget \
    curl \
    gnupg \
    lsb-release \
    software-properties-common \
    libssl-dev \
    openssl \
    binutils \
    file \
    && rm -rf /var/lib/apt/lists/*

# Add LLVM apt repository for latest packages
RUN wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
RUN echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" >> /etc/apt/sources.list.d/llvm.list

# Install LLVM 18 (latest stable with good MLIR support)
RUN apt-get update && apt-get install -y \
    clang-18 \
    llvm-18 \
    llvm-18-dev \
    llvm-18-tools \
    mlir-18-tools \
    libmlir-18-dev \
    lld-18 \
    && rm -rf /var/lib/apt/lists/*

# Create symlinks for tools
RUN update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100 && \
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100 && \
    update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-18 100 && \
    ln -sf /usr/bin/mlir-opt-18 /usr/bin/mlir-opt && \
    ln -sf /usr/bin/mlir-translate-18 /usr/bin/mlir-translate

# Set environment
ENV PATH="/usr/lib/llvm-18/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/lib/llvm-18/lib"
ENV LLVM_DIR="/usr/lib/llvm-18/lib/cmake/llvm"
ENV MLIR_DIR="/usr/lib/llvm-18/lib/cmake/mlir"

# ============================================================================
# STAGE 2: Verify installation
# ============================================================================

RUN echo "=== Verifying LLVM/MLIR Installation ===" && \
    clang --version && \
    mlir-opt --version && \
    mlir-translate --version && \
    echo "✅ LLVM/MLIR tools installed successfully"

# Note: ClangIR is experimental and not in pre-built packages
# The pipeline will automatically fall back to standard Clang → LLVM IR → MLIR

# ============================================================================
# STAGE 3: Copy project and build MLIR obfuscation passes
# ============================================================================

WORKDIR /app
COPY . .

# Build MLIR obfuscation passes
WORKDIR /app/mlir-obs
RUN mkdir -p build && cd build && \
    cmake .. \
        -G Ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DLLVM_DIR=/usr/lib/llvm-18/lib/cmake/llvm \
        -DMLIR_DIR=/usr/lib/llvm-18/lib/cmake/mlir && \
    ninja

# Verify the library was built
RUN echo "=== Verifying MLIR Obfuscation Library ===" && \
    ls -la /app/mlir-obs/build/lib/ && \
    echo "✅ MLIR Obfuscation library built"

# ============================================================================
# STAGE 4: Install Python dependencies
# ============================================================================

WORKDIR /app/cmd/llvm-obfuscator
RUN pip3 install --no-cache-dir -r requirements.txt || pip3 install --no-cache-dir typer pyyaml

# ============================================================================
# STAGE 5: Setup and permissions
# ============================================================================

WORKDIR /app

# Make scripts executable
RUN chmod +x mlir-obs/build.sh mlir-obs/test.sh 2>/dev/null || true
RUN chmod +x mlir-obs/test-clangir-pipeline.sh 2>/dev/null || true

# Create a simple test script
RUN echo '#!/bin/bash' > /usr/local/bin/test-pipeline && \
    echo 'set -e' >> /usr/local/bin/test-pipeline && \
    echo 'echo "=== Testing MLIR Obfuscation Pipeline ==="' >> /usr/local/bin/test-pipeline && \
    echo 'cd /app' >> /usr/local/bin/test-pipeline && \
    echo '' >> /usr/local/bin/test-pipeline && \
    echo '# Create test file' >> /usr/local/bin/test-pipeline && \
    echo 'cat > /tmp/test.c << EOF' >> /usr/local/bin/test-pipeline && \
    echo '#include <stdio.h>' >> /usr/local/bin/test-pipeline && \
    echo 'const char* SECRET = "MyPassword123";' >> /usr/local/bin/test-pipeline && \
    echo 'int main() { printf("Hello: %s\\n", SECRET); return 0; }' >> /usr/local/bin/test-pipeline && \
    echo 'EOF' >> /usr/local/bin/test-pipeline && \
    echo '' >> /usr/local/bin/test-pipeline && \
    echo '# Test compilation with obfuscation' >> /usr/local/bin/test-pipeline && \
    echo 'python3 -m cmd.llvm-obfuscator.cli.obfuscate compile /tmp/test.c \' >> /usr/local/bin/test-pipeline && \
    echo '    --enable-string-encrypt \' >> /usr/local/bin/test-pipeline && \
    echo '    --enable-symbol-obfuscate \' >> /usr/local/bin/test-pipeline && \
    echo '    --output /tmp/output' >> /usr/local/bin/test-pipeline && \
    echo '' >> /usr/local/bin/test-pipeline && \
    echo 'echo ""' >> /usr/local/bin/test-pipeline && \
    echo 'echo "=== Verifying Obfuscation ==="' >> /usr/local/bin/test-pipeline && \
    echo 'if [ -f /tmp/output/test ]; then' >> /usr/local/bin/test-pipeline && \
    echo '    echo "Binary created: /tmp/output/test"' >> /usr/local/bin/test-pipeline && \
    echo '    /tmp/output/test' >> /usr/local/bin/test-pipeline && \
    echo '    echo ""' >> /usr/local/bin/test-pipeline && \
    echo '    echo "Checking for hidden strings..."' >> /usr/local/bin/test-pipeline && \
    echo '    if strings /tmp/output/test | grep -q "MyPassword123"; then' >> /usr/local/bin/test-pipeline && \
    echo '        echo "❌ String still visible"' >> /usr/local/bin/test-pipeline && \
    echo '    else' >> /usr/local/bin/test-pipeline && \
    echo '        echo "✅ String hidden!"' >> /usr/local/bin/test-pipeline && \
    echo '    fi' >> /usr/local/bin/test-pipeline && \
    echo 'else' >> /usr/local/bin/test-pipeline && \
    echo '    echo "❌ Binary not created"' >> /usr/local/bin/test-pipeline && \
    echo '    exit 1' >> /usr/local/bin/test-pipeline && \
    echo 'fi' >> /usr/local/bin/test-pipeline && \
    chmod +x /usr/local/bin/test-pipeline

# Default command
CMD ["/bin/bash"]
