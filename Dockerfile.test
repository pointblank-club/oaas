FROM ubuntu:22.04

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# ============================================================================
# STAGE 1: Install base dependencies
# ============================================================================
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    ninja-build \
    git \
    python3 \
    python3-pip \
    wget \
    curl \
    binutils \
    file \
    xz-utils \
    software-properties-common \
    lsb-release \
    libssl-dev \
    openssl \
    zlib1g-dev \
    libtinfo-dev \
    libxml2-dev \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# STAGE 2: Build LLVM/Clang/MLIR with ClangIR (CIR) support from source
# This is required because:
# 1. ClangIR (CIR) is an experimental feature requiring special build flags
# 2. We need matching versions of clang, mlir-opt, cir-opt, mlir-translate
# 3. Standard packages don't include CIR support
# ============================================================================

WORKDIR /opt

# Clone LLVM monorepo - use main branch for latest ClangIR support
# ClangIR is actively developed and requires recent LLVM
RUN git clone --depth=1 https://github.com/llvm/llvm-project.git llvm-project

# Build LLVM with ClangIR enabled
WORKDIR /opt/llvm-project/build
RUN cmake ../llvm \
    -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DLLVM_ENABLE_PROJECTS="clang;mlir" \
    -DLLVM_TARGETS_TO_BUILD="X86;AArch64" \
    -DLLVM_ENABLE_ASSERTIONS=OFF \
    -DLLVM_ENABLE_RTTI=ON \
    -DLLVM_BUILD_EXAMPLES=OFF \
    -DLLVM_INCLUDE_TESTS=OFF \
    -DLLVM_INCLUDE_BENCHMARKS=OFF \
    -DCLANG_ENABLE_CIR=ON \
    -DCMAKE_INSTALL_PREFIX=/usr/local/llvm \
    && ninja clang mlir-opt mlir-translate cir-opt || echo "CIR tools build attempted"

# Install LLVM to /usr/local/llvm
RUN ninja install || echo "Installation attempted"

# ============================================================================
# STAGE 3: Set up environment
# ============================================================================

# Set environment variables for LLVM
ENV PATH="/usr/local/llvm/bin:${PATH}"
ENV LD_LIBRARY_PATH="/usr/local/llvm/lib:${LD_LIBRARY_PATH}"
ENV LLVM_DIR="/usr/local/llvm/lib/cmake/llvm"
ENV MLIR_DIR="/usr/local/llvm/lib/cmake/mlir"

# Create compatibility wrapper script for 'clangir' command
# This makes 'clangir' a convenient alias for 'clang -fclangir'
RUN echo '#!/bin/bash' > /usr/local/bin/clangir && \
    echo '# ClangIR wrapper - invokes clang with CIR support' >> /usr/local/bin/clangir && \
    echo 'exec clang -fclangir "$@"' >> /usr/local/bin/clangir && \
    chmod +x /usr/local/bin/clangir

# ============================================================================
# STAGE 4: Verify installation
# ============================================================================

RUN echo "=== Verifying LLVM/ClangIR Installation ===" && \
    echo "Clang version:" && clang --version && \
    echo "" && \
    echo "MLIR tools:" && \
    which mlir-opt && mlir-opt --version && \
    which mlir-translate && mlir-translate --version && \
    echo "" && \
    echo "ClangIR tools:" && \
    (which cir-opt && cir-opt --version) || echo "cir-opt not available (CIR may be disabled)" && \
    echo "" && \
    echo "ClangIR flag test:" && \
    (echo 'int main() { return 0; }' | clang -fclangir -x c - -emit-cir -o /dev/null 2>&1 && echo "✅ ClangIR (-fclangir) works!") || \
    echo "⚠️ ClangIR not available, falling back to standard pipeline"

# ============================================================================
# STAGE 5: Copy project and build MLIR obfuscation passes
# ============================================================================

WORKDIR /app
COPY . .

# Build MLIR obfuscation passes
WORKDIR /app/mlir-obs
RUN mkdir -p build && cd build && \
    cmake .. \
        -G Ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DLLVM_DIR=/usr/local/llvm/lib/cmake/llvm \
        -DMLIR_DIR=/usr/local/llvm/lib/cmake/mlir && \
    ninja || make -j$(nproc)

# Verify the MLIR obfuscation library was built
RUN echo "=== Verifying MLIR Obfuscation Library ===" && \
    ls -la /app/mlir-obs/build/lib/ && \
    (ls /app/mlir-obs/build/lib/*.so 2>/dev/null || ls /app/mlir-obs/build/lib/*.dylib 2>/dev/null) && \
    echo "✅ MLIR Obfuscation library built successfully"

# ============================================================================
# STAGE 6: Install Python dependencies
# ============================================================================

WORKDIR /app/cmd/llvm-obfuscator
RUN pip3 install -r requirements.txt || echo "No requirements.txt found"

# ============================================================================
# STAGE 7: Set up working directory and permissions
# ============================================================================

WORKDIR /app

# Make test scripts executable
RUN chmod +x mlir-obs/build.sh 2>/dev/null || true && \
    chmod +x mlir-obs/test.sh 2>/dev/null || true && \
    chmod +x cmd/llvm-obfuscator/tests/run_integrations_test.sh 2>/dev/null || true && \
    chmod +x cmd/llvm-obfuscator/tests/test_mlir_passes_only.sh 2>/dev/null || true

# Create a test script for ClangIR pipeline verification
RUN echo '#!/bin/bash' > /usr/local/bin/test-clangir-pipeline && \
    echo 'set -e' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'echo "Testing ClangIR Pipeline..."' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'echo "int add(int a, int b) { return a + b; } int main() { return add(1, 2); }" > /tmp/test.c' >> /usr/local/bin/test-clangir-pipeline && \
    echo '' >> /usr/local/bin/test-clangir-pipeline && \
    echo '# Test 1: ClangIR emit' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'if clang -fclangir -emit-cir /tmp/test.c -o /tmp/test.cir 2>/dev/null; then' >> /usr/local/bin/test-clangir-pipeline && \
    echo '  echo "✅ Step 1: ClangIR emit works"' >> /usr/local/bin/test-clangir-pipeline && \
    echo '  cat /tmp/test.cir' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'else' >> /usr/local/bin/test-clangir-pipeline && \
    echo '  echo "⚠️ Step 1: ClangIR not available, using standard pipeline"' >> /usr/local/bin/test-clangir-pipeline && \
    echo '  exit 0' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'fi' >> /usr/local/bin/test-clangir-pipeline && \
    echo '' >> /usr/local/bin/test-clangir-pipeline && \
    echo '# Test 2: CIR lowering' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'if which cir-opt >/dev/null 2>&1; then' >> /usr/local/bin/test-clangir-pipeline && \
    echo '  cir-opt /tmp/test.cir --cir-to-llvm -o /tmp/test.llvm.mlir && echo "✅ Step 2: CIR lowering works"' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'else' >> /usr/local/bin/test-clangir-pipeline && \
    echo '  echo "⚠️ Step 2: cir-opt not available"' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'fi' >> /usr/local/bin/test-clangir-pipeline && \
    echo '' >> /usr/local/bin/test-clangir-pipeline && \
    echo '# Test 3: Full compilation' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'clang -fclangir /tmp/test.c -o /tmp/test_clangir && echo "✅ Step 3: Full ClangIR compilation works"' >> /usr/local/bin/test-clangir-pipeline && \
    echo '/tmp/test_clangir && echo "✅ Step 4: Binary executes correctly"' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'echo ""' >> /usr/local/bin/test-clangir-pipeline && \
    echo 'echo "ClangIR Pipeline Test: PASSED"' >> /usr/local/bin/test-clangir-pipeline && \
    chmod +x /usr/local/bin/test-clangir-pipeline

# Default command
CMD ["/bin/bash"]
