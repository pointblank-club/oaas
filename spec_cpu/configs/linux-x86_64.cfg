# SPEC CPU 2017 Configuration for Linux x86_64
# LLVM Obfuscator Benchmarking Module
#
# Toolchain Selection Logic:
# ============================================================================
# BASELINE BUILD:
#   1. Preferred: Custom Clang from plugins/ (if available)
#      - Uses: ${BASELINE_CC} = plugins/clang, ${BASELINE_CXX} = plugins/clang++
#      - Flags: -O3 -march=native (or custom baseline flags)
#   2. Fallback: System GCC/G++ with Clang-compatible flags
#      - Uses: ${BASELINE_CC} = gcc, ${BASELINE_CXX} = g++
#      - Flags: -O3 -march=native (MANDATORY -O3 for baseline)
#
# OBFUSCATED BUILD:
#   - REQUIRED: Custom Clang from plugins/ (NO fallback)
#   - Uses: ${OBFUSCC} = plugins/clang, ${OBFUSCXX} = plugins/clang++
#   - Flags: -O3 + obfuscation flags from LLVM obfuscator
#   - If plugins/ unavailable: build_spec_targets.sh will FAIL with clear error
#
# Variable Injection by build_spec_targets.sh:
# ============================================================================
# The build script will replace:
#   ${BASELINE_CC}    -> Path to baseline C compiler
#   ${BASELINE_CXX}   -> Path to baseline C++ compiler
#   ${OBFUSCC}        -> Path to obfuscated C compiler (clang from plugins/)
#   ${OBFUSCXX}       -> Path to obfuscated C++ compiler (clang++ from plugins/)
#   ${BASELINE_FLAGS} -> Baseline optimization flags (includes -O3)
#   ${OBFUS_FLAGS}    -> Obfuscation flags (from LLVM obfuscator config)
#   ${LLVM_PLUGIN_PATH} -> Path to LLVMObfuscationPlugin.so

# =============================================================================
# SPEC CPU 2017 System Declaration
# =============================================================================
[system]
label = LLVM Obfuscator SPEC CPU 2017 Benchmarking Suite
hw_model = Linux x86_64 Architecture
hw_cpu_name = Intel/AMD x86_64
hw_cpu_mhz = default
hw_memory = default
hw_disk = default
sw_os = Linux
sw_compiler = LLVM Clang / GCC

# =============================================================================
# Build Preparation
# =============================================================================
[prerun]
prerun_cmd = true
# Note: SPEC CPU will handle benchmark-specific pre-run tasks

# =============================================================================
# Baseline Configuration
# =============================================================================
# Compiler paths injected by build_spec_targets.sh --build-type baseline
# Example after injection:
#   CC = /opt/clang/bin/clang (or /usr/bin/gcc)
#   CXX = /opt/clang/bin/clang++ (or /usr/bin/g++)
#
# Flags: ${BASELINE_FLAGS} will be:
#   Custom Clang baseline: -O3 -march=native -fno-strict-aliasing
#   GCC fallback baseline: -O3 -march=native -fno-strict-aliasing
# ============================================================================

[default_baseline]
CC = ${BASELINE_CC}
CXX = ${BASELINE_CXX}
FC = gfortran
CFLAGS = -O3 -march=native -fno-strict-aliasing
CXXFLAGS = -O3 -march=native -fno-strict-aliasing
FFLAGS = -O3 -march=native
LDFLAGS =
OPTIMIZE = -O3

# Baseline output directory naming
RUNDIR = baseline_${TIMESTAMP}
OUTPUT_FORMAT = text

# Baseline result identification
tune = base
size = any
basemark = baseline

# =============================================================================
# Obfuscation Configuration (Peak)
# =============================================================================
# Compiler paths injected by build_spec_targets.sh --build-type obfuscated
# Example after injection:
#   CC = /path/to/plugins/clang
#   CXX = /path/to/plugins/clang++
#
# This MUST use custom Clang from plugins/ directory.
# If plugins/ unavailable, build_spec_targets.sh will FAIL before reaching this.
#
# Flags: ${OBFUS_FLAGS} will include:
#   -O3 -march=native (from baseline)
#   -mllvm -<obfuscation_pass_1> -mllvm -<obfuscation_pass_2> ... (from config)
#   -Xclang -plugin -Xclang LLVMObfuscationPlugin.so
#   -Xclang -plugin-arg-LLVMObfuscationPlugin -Xclang <obfuscation_args>
# ============================================================================

[peak_obfuscation]
CC = ${OBFUSCC}
CXX = ${OBFUSCXX}
FC = gfortran
CFLAGS = ${OBFUS_FLAGS}
CXXFLAGS = ${OBFUS_FLAGS}
FFLAGS = -O3 -march=native
LDFLAGS = -L${LLVM_PLUGIN_PATH}/../lib
OPTIMIZE = -O3

# Obfuscated output directory naming
RUNDIR = obfuscated_${OBFUS_CONFIG}_${TIMESTAMP}
OUTPUT_FORMAT = text

# Obfuscated result identification
tune = peak
size = any
basemark = obfuscated_${OBFUS_CONFIG}

# =============================================================================
# Common Compilation Flags
# =============================================================================
# These flags are applied to both baseline and obfuscated builds
# to ensure semantic compatibility where possible

COMMON_PORTABILITY = -DSPEC_CPU_LP64 -DSPEC_CPU_LINUX_X86_64

# Floating-point settings (consistent between baseline and obfuscated)
FLOAT_FLAGS =
FP_PORTABILITY = -DSPEC_CPU_LP64

# Integer portability
INT_PORTABILITY = -DSPEC_CPU_LP64

# =============================================================================
# SPECspeed Configuration (Single-threaded Benchmarks)
# =============================================================================
[specspeed]
max_parallel_compiles = 4
verbose = 1
iterations = 3
copies = 1
runmode = speed

# Use baseline or peak configuration
use_config = default_baseline  # For baseline runs
# use_config = peak_obfuscation  # For obfuscated runs (injected by script)

# =============================================================================
# SPECrate Configuration (Multi-threaded Benchmarks)
# =============================================================================
[specrate]
max_parallel_compiles = 4
verbose = 1
iterations = 3
copies = ${NUM_THREADS}  # Injected by run_spec_rate.sh (default: CPU count)
runmode = rate

# Use baseline or peak configuration
use_config = default_baseline  # For baseline runs
# use_config = peak_obfuscation  # For obfuscated runs (injected by script)

# =============================================================================
# Benchmark Selection
# =============================================================================
# SPECspeed 2017: Integer benchmarks
# ============================================================================
[500.perlbench_r]
derived_exename = perlbench_r
extra_cflags = -fno-strict-aliasing

[502.gcc_r]
derived_exename = gcc_r
extra_cflags = -fno-strict-aliasing

[505.mcf_r]
derived_exename = mcf_r

[520.omnetpp_r]
derived_exename = omnetpp_r
extra_cxxflags = -fno-strict-aliasing

[523.xalancbmk_r]
derived_exename = xalancbmk_r
extra_cxxflags = -fno-strict-aliasing

[525.x264_r]
derived_exename = x264_r
extra_cflags = -fno-strict-aliasing

[531.deepsjeng_r]
derived_exename = deepsjeng_r

[541.leela_r]
derived_exename = leela_r
extra_cxxflags = -fno-strict-aliasing

[548.exchange2_r]
derived_exename = exchange2_r
extra_cflags = -fno-strict-aliasing

[557.xz_r]
derived_exename = xz_r

# =============================================================================
# SPECspeed 2017: Floating-point benchmarks
# ============================================================================
[503.bwaves_r]
derived_exename = bwaves_r
extra_cflags = -fno-strict-aliasing

[507.cactuBSSN_r]
derived_exename = cactuBSSN_r
extra_cflags = -fno-strict-aliasing

[508.namd_r]
derived_exename = namd_r
extra_cxxflags = -fno-strict-aliasing

[510.parest_r]
derived_exename = parest_r
extra_cxxflags = -fno-strict-aliasing

[511.povray_r]
derived_exename = povray_r
extra_cxxflags = -fno-strict-aliasing

[519.lbm_r]
derived_exename = lbm_r

[521.wrf_r]
derived_exename = wrf_r
extra_fflags = -fno-strict-aliasing

[526.blender_r]
derived_exename = blender_r
extra_cxxflags = -fno-strict-aliasing

[527.cam4_r]
derived_exename = cam4_r
extra_fflags = -fno-strict-aliasing

[538.imagick_r]
derived_exename = imagick_r
extra_cflags = -fno-strict-aliasing

[544.nab_r]
derived_exename = nab_r
extra_cflags = -fno-strict-aliasing

[549.fotonik3d_r]
derived_exename = fotonik3d_r

[554.roms_r]
derived_exename = roms_r
extra_fflags = -fno-strict-aliasing

# =============================================================================
# Output and Reporting
# =============================================================================
[output]
output_format = text

# Result file naming convention
# baseline: results/baseline/<timestamp>/{speed,rate}/
# obfuscated: results/obfuscated/<config>/<timestamp>/{speed,rate}/
result_directory = ${RESULT_DIR}  # Injected by run_spec_*.sh scripts

# =============================================================================
# Reporting Configuration
# =============================================================================
[reporting]
print_config = 1
use_strict_binding = 0
hw_avail = Sep-2025
estimate_power = 0

# =============================================================================
# Error Handling
# =============================================================================
[error_handling]
ignore_errors = 0
stop_on_error = 1
verbose_errors = 1

# Log location: spec_cpu/results/baseline/<timestamp>/SPEC_build.log
#           or: spec_cpu/results/obfuscated/<config>/<timestamp>/SPEC_build.log

# =============================================================================
# Notes for build_spec_targets.sh
# =============================================================================
#
# The build script performs variable substitution before invoking SPEC CPU:
#
# 1. Detect build type (baseline or obfuscated)
#
# 2. For BASELINE builds:
#    - Check if plugins/clang exists
#      YES: Set BASELINE_CC=plugins/clang, BASELINE_CXX=plugins/clang++
#      NO:  Set BASELINE_CC=gcc, BASELINE_CXX=g++
#    - Ensure -O3 is in BASELINE_FLAGS
#    - Replace ${BASELINE_CC}, ${BASELINE_CXX}, ${BASELINE_FLAGS}
#
# 3. For OBFUSCATED builds:
#    - Check if plugins/clang exists
#      YES: Set OBFUSCC=plugins/clang, OBFUSCXX=plugins/clang++
#      NO:  FAIL with error message "Custom Clang required for obfuscated builds"
#    - Build OBFUS_FLAGS from:
#      * -O3 -march=native (base)
#      * -mllvm flags from obfuscation configuration
#      * -Xclang plugin flags for LLVMObfuscationPlugin.so
#    - Set LLVM_PLUGIN_PATH to plugins/ directory
#    - Replace ${OBFUSCC}, ${OBFUSCXX}, ${OBFUS_FLAGS}, ${LLVM_PLUGIN_PATH}
#
# 4. For both builds:
#    - Set TIMESTAMP to current ISO 8601 timestamp
#    - Set RESULT_DIR to results/{baseline,obfuscated}/<config>/<timestamp>
#    - Set OBFUS_CONFIG to configuration name (if obfuscated)
#    - Set NUM_THREADS for SPECrate (default: nproc)
#
# 5. Invoke SPEC CPU runcpu with modified config:
#    $ runcpu --config linux-x86_64.cfg --size ref --speed (or --rate)
#
# =============================================================================
# End of Configuration File
# =============================================================================
